const fs=require("fs");const path=require("path");const os=require("os");const STORAGE_DIR=path.join(os.homedir(),".moltmanager");const MOLTBOTS_FILE=path.join(STORAGE_DIR,"moltbots.json");function ensureStorageDir(){if(!fs.existsSync(STORAGE_DIR))fs.mkdirSync(STORAGE_DIR,{recursive:!0})}function readMoltbots(){ensureStorageDir();if(!fs.existsSync(MOLTBOTS_FILE))return[];try{return JSON.parse(fs.readFileSync(MOLTBOTS_FILE,"utf-8"))}catch(e){console.error("Error reading moltbots file.");return[]}}function writeMoltbots(m){ensureStorageDir();fs.writeFileSync(MOLTBOTS_FILE,JSON.stringify(m,null,2))}function getNextId(i){return 0===i.length?1:Math.max(...i.map(i=>i.id))+1}function createMoltbot(n,s,t=[],m="claude-sonnet-4"){const b=readMoltbots();if(b.find(m=>m.name===n))throw new Error("Moltbot ""+n+"" already exists");const newM={id:getNextId(b),name:n,systemPrompt:s,tags:Array.isArray(t)?t:[],model:m,temperature:.7,created:new Date().toISOString(),lastUsed:new Date().toISOString()};b.push(newM);writeMoltbots(b);return newM}function listMoltbots(t=null){const m=readMoltbots();return t?m.filter(m=>m.tags&&m.tags.includes(t)):m}function getMoltbot(n){return readMoltbots().find(m=>m.name===n)||null}function getMoltbotById(i){return readMoltbots().find(m=>m.id===i)||null}function updateMoltbot(n,u){const m=readMoltbots();const i=m.findIndex(m=>m.name===n);if(-1===i)return null;m[i]={...m[i],...u,lastUsed:new Date().toISOString()};writeMoltbots(m);return m[i]}function deleteMoltbot(n){const m=readMoltbots();const f=m.filter(m=>m.name!==n);if(f.length===m.length)return!1;writeMoltbots(f);return!0}function renameMoltbot(o,n){const m=readMoltbots();if(m.find(m=>m.name===n))throw new Error("Moltbot ""+n+"" already exists");const mb=m.find(m=>m.name===o);if(!mb)return null;mb.name=n;writeMoltbots(m);return mb}function searchMoltbots(q){const m=readMoltbots();const l=q.toLowerCase();return m.filter(m=>m.name.toLowerCase().includes(l)||m.systemPrompt.toLowerCase().includes(l)||(m.tags&&m.tags.some(t=>t.toLowerCase().includes(l))))}function getAllTags(){const m=readMoltbots();const ts=new Set();m.forEach(m=>{if(m.tags)m.tags.forEach(t=>ts.add(t))});return Array.from(ts).sort()}function exportMoltbot(n){const m=getMoltbot(n);if(!m)return null;const e={name:m.name,systemPrompt:m.systemPrompt,tags:m.tags,model:m.model,temperature:m.temperature};return JSON.stringify(e,null,2)}function importMoltbot(j,o=!1){const d=JSON.parse(j);if(!d.name||!d.systemPrompt)throw new Error("Invalid moltbot data");const e=getMoltbot(d.name);if(e&&!o)throw new Error("Moltbot ""+d.name+"" already exists. Use --overwrite to replace.");if(e&&o)deleteMoltbot(d.name);return createMoltbot(d.name,d.systemPrompt,d.tags||[],d.model||"claude-sonnet-4")}function backupAll(){return JSON.stringify(readMoltbots(),null,2)}function getStorageDir(){return STORAGE_DIR}function getStats(){const m=readMoltbots();const t=getAllTags();return{total:m.length,tags:t.length,mostRecent:m.length>0?m.sort((a,b)=>new Date(b.lastUsed)-new Date(a.lastUsed))[0].name:null}}module.exports={createMoltbot,listMoltbots,getMoltbot,getMoltbotById,updateMoltbot,deleteMoltbot,renameMoltbot,searchMoltbots,getAllTags,exportMoltbot,importMoltbot,backupAll,getStorageDir,getStats};